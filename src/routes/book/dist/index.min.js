"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _express=_interopRequireDefault(require("express")),db=_interopRequireWildcard(require("../../database/models")),_catchHandle=_interopRequireDefault(require("./../../middlewares/catchHandle")),eResponse=_interopRequireWildcard(require("./../../config/eResponse")),_bookServices=_interopRequireDefault(require("../../webServices/bookServices")),_userServices=_interopRequireDefault(require("../../webServices/userServices")),_constant=require("../../config/constant"),_checklogin=_interopRequireDefault(require("../../middlewares/checklogin")),_loaibookServices=_interopRequireDefault(require("./../../webServices/loaibookServices")),_sequelize=require("sequelize"),_multer=_interopRequireDefault(require("multer")),_path=_interopRequireDefault(require("path"));function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return _getRequireWildcardCache=function(){return e},e}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};var r=_getRequireWildcardCache();if(r&&r.has(e))return r.get(e);var t={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if(Object.prototype.hasOwnProperty.call(e,o)){var a=n?Object.getOwnPropertyDescriptor(e,o):null;a&&(a.get||a.set)?Object.defineProperty(t,o,a):t[o]=e[o]}return t.default=e,r&&r.set(e,t),t}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var router=_express.default.Router(),storage=_multer.default.diskStorage({destination:function(e,r,t){t(null,"./public/uploads/")},filename:function(e,r,t){t(null,r.fieldname+"-"+Date.now()+_path.default.extname(r.originalname))}}),upload=(0,_multer.default)({storage:storage});router.get("/admin",(0,_catchHandle.default)(function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(_bookServices.default.getBook());case 2:t=e.sent,console.log("abc",t),r.render("index");case 5:case"end":return e.stop()}})})),router.get("/sign-up",(0,_catchHandle.default)(function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(db.users.findAll({}));case 2:return t=e.sent,console.log("abc",t),r.render("sign-up",{users:t}),e.abrupt("return",t);case 6:case"end":return e.stop()}})})),router.post("/sign-up",(0,_catchHandle.default)(function(r,t){var n,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log(r.body),e.next=3,regeneratorRuntime.awrap(db.users.findOne({where:{phonenumber:r.body.phonenumber}}));case 3:if(n=e.sent,console.log("o day",n),n)return console.log("vao if"),r.flash("loi","có lỗi xảy ra"),e.abrupt("return",t.redirect("/sign-up"));e.next=11;break;case 11:return e.next=13,regeneratorRuntime.awrap(_userServices.default.createUser(r.body));case 13:if(!(o=e.sent)||o.error)return e.abrupt("return",t.send(eResponse._errorByHand(o?t.error:" System Error")));e.next=16;break;case 16:return console.log("vao else"),e.abrupt("return",t.redirect("/login").send(eResponse._success(o)));case 18:case"end":return e.stop()}})})),router.get("/table",(0,_catchHandle.default)(function(e,r){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:r.render("table");case 1:case"end":return e.stop()}})})),router.get("/create-book",(0,_catchHandle.default)(function(r,t){var n,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(db.sales.findAll({}));case 2:return n=e.sent,e.next=5,regeneratorRuntime.awrap(_bookServices.default.getbookadmin(r.query.keySearch,r.query.page));case 5:return o=e.sent,t.render("book",{listbook:o.rows,sale:n,pages:o.pages,a:o.current}),e.abrupt("return",o);case 8:case"end":return e.stop()}})})),router.post("/create-book",upload.single("image"),(0,_catchHandle.default)(function(r,t){var n,o,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log(r.body),console.log("hahah",r.body.loaibookId),r.body.image=r.file.filename,e.next=5,regeneratorRuntime.awrap(_bookServices.default.createBook(r.body,r.body.image));case 5:return n=e.sent,e.next=8,regeneratorRuntime.awrap(db.books.findOne({order:[["id","desc"]]}));case 8:return o=e.sent,console.log("reswarehouse",o.id),a={bookId:String(o.id),soluongton:r.body.soluongton},e.next=13,regeneratorRuntime.awrap(_bookServices.default.createWarehouse(a));case 13:if(e.sent,!n||n.error)return e.abrupt("return",t.send(eResponse._errorByHand(n?n.error:" System Error ")));e.next=16;break;case 16:t.redirect("/create-book").send(eResponse._success(n));case 17:case"end":return e.stop()}})})),router.get("/deletebook",(0,_catchHandle.default)(function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(db.books.destroy({where:{id:r.query.bookid}}));case 2:n=e.sent,t.send(eResponse._success(n));case 4:case"end":return e.stop()}})})),router.get("/create-category",(0,_catchHandle.default)(function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(db.loaibooks.findAll({}));case 2:t=e.sent,r.render("categorycreate",{infobook:t});case 4:case"end":return e.stop()}})})),router.post("/create-category",(0,_catchHandle.default)(function(r,t){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log(r.body),e.next=3,regeneratorRuntime.awrap(_loaibookServices.default.createloaiBook(r.body));case 3:e.sent,t.redirect("/create-book");case 5:case"end":return e.stop()}})})),router.get("/deletecategory",(0,_catchHandle.default)(function(r,t){var n,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(db.loaibooks.destroy({where:{id:r.query.id}}));case 2:return n=e.sent,e.next=5,regeneratorRuntime.awrap(db.books.destroy({where:{loaibookId:r.query.id}}));case 5:o=e.sent,t.send(eResponse._success(n,o));case 7:case"end":return e.stop()}})})),router.get("/",_checklogin.default,(0,_catchHandle.default)(function(r,t){var n,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("checklogin",r.session.phone),console.log(r.body),console.log(r.params),console.log(r.query),e.next=6,regeneratorRuntime.awrap(_bookServices.default.getBook(r.query.keySearch,r.query.page));case 6:n=e.sent,o=Number(n.current),console.log("a",o),t.render("view",{book:n.rows,page:n.pages,a:o});case 10:case"end":return e.stop()}})})),router.get("/thong-tin-book/:bookid",(0,_catchHandle.default)(function(r,t){var n,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return r.session.bookid=r.params.bookid,console.log(r.session),e.next=4,regeneratorRuntime.awrap(db.sales.findOne({where:{bookId:r.params.bookid}}));case 4:return n=e.sent,e.next=7,regeneratorRuntime.awrap(_bookServices.default.getinfobook(r.params.bookid));case 7:return o=e.sent,e.next=10,regeneratorRuntime.awrap(db.bookcarts.findAll({}));case 10:e.sent,t.render("infobook",{infobook:o,sale:n});case 12:case"end":return e.stop()}})})),router.get("/search",(0,_catchHandle.default)(function(r,t){var n,o,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log(r.query),e.next=3,regeneratorRuntime.awrap(_bookServices.default.searchbook(r.query));case 3:n=e.sent,o=Number(n.current),a=r.query.q,t.render("viewsearch",{book:n.rows,page:n.pages,a:o,b:a});case 7:case"end":return e.stop()}})})),router.get("/test",(0,_catchHandle.default)(function(){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}})}));var _default=router;exports.default=_default;
//# sourceMappingURL=index.min.js.map
