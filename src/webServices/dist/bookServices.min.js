"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _lodash=_interopRequireDefault(require("lodash")),_constant=require("../config/constant"),_sequelize=require("sequelize"),db=_interopRequireWildcard(require("../database/models")),cache=_interopRequireWildcard(require("../cache")),_stringHelpers=require("../utilities/stringHelpers");function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return _getRequireWildcardCache=function(){return e},e}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache();if(t&&t.has(e))return t.get(e);var r={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if(Object.prototype.hasOwnProperty.call(e,o)){var a=n?Object.getOwnPropertyDescriptor(e,o):null;a&&(a.get||a.set)?Object.defineProperty(r,o,a):r[o]=e[o]}return r.default=e,t&&t.set(e,r),r}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var cacheTime=3600,createBook=function(t){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.loaibookId){e.next=2;break}return e.abrupt("return",{error:_constant.bookRequestCheck.loai_bookId});case 2:if(t.loaibookId=(0,_stringHelpers.removeTagHtml)(t.loaibookId),t.image){e.next=5;break}return e.abrupt("return",{error:_constant.bookRequestCheck.imageRequire});case 5:if(t.image=t.image,t.title){e.next=8;break}return e.abrupt("return",{error:_constant.bookRequestCheck.titleRequire});case 8:if(t.title=(0,_stringHelpers.removeTagHtml)(t.title),t.author){e.next=11;break}return e.abrupt("return",{error:_constant.bookRequestCheck.authorId});case 11:if(t.author=(0,_stringHelpers.removeTagHtml)(t.author),t.cost){e.next=14;break}return e.abrupt("return",{error:_constant.bookRequestCheck.costRequire});case 14:return t.cost=(0,_stringHelpers.removeTagHtml)(t.cost),e.next=17,regeneratorRuntime.awrap(db.books.create(t));case 17:return e.abrupt("return",e.sent);case 18:case"end":return e.stop()}})},getBook=function(){var t,r,n,o,a,s,u,c,i=arguments;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return r=1<i.length&&void 0!==i[1]?i[1]:1,o={title:n=2<i.length?i[2]:void 0,status:"publish"},(t=0<i.length&&void 0!==i[0]&&i[0])&&(t=(0,_stringHelpers.removeTagHtml)(((0,_stringHelpers.xoaDau)(t)," ")),o.title=_defineProperty({},_sequelize.Op.substring,(0,_stringHelpers.removeTagHtml)(t))),console.log("search",n),a=((r=r||1)-1)*_constant.BOOK_LIMIT,s="__book_search_keysearch_"+t+"_page_"+r+"_offset_"+a,console.log("keycache",s),e.next=12,regeneratorRuntime.awrap(cache.get(s,!0));case 12:if(u=e.sent,console.log("cacheData",u),u)return e.abrupt("return",u);e.next=16;break;case 16:return e.next=18,regeneratorRuntime.awrap(db.books.findAndCountAll({where:{status:o.status},include:{model:db.sales,requied:!0},limit:_constant.BOOK_LIMIT,offset:a,order:[["id","desc"]]}));case 18:return(c=e.sent).pages=Math.ceil(c.count/_constant.BOOK_LIMIT),c.current=r,cache.set(s,c,cacheTime,!0),console.log("page",r),e.abrupt("return",c);case 24:case"end":return e.stop()}})},searchbook=function(t){var r,n=arguments;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return 1<n.length&&void 0!==n[1]?n[1]:1,console.log("data",t),e.next=4,regeneratorRuntime.awrap(db.books.findAndCountAll({attributes:["id","loaibookId","image","title","status","author","cost","createdAt","updatedAt"],where:_defineProperty({},_sequelize.Op.and,{status:"publish",title:_defineProperty({},_sequelize.Op.startsWith,"%"+t.q)})}));case 4:return r=e.sent,e.abrupt("return",r);case 6:case"end":return e.stop()}})},getbooks=function(){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return t=db.books.findAll({}),e.abrupt("return",t);case 2:case"end":return e.stop()}})},getinfobook=function(t){var r;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(db.books.findOne({where:{id:t}}));case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}})},createWarehouse=function(t){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("warehouse",t),e.next=3,regeneratorRuntime.awrap(db.warehouses.create(t));case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}})},upsoluongton=function(t){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("upsoluongton",t),e.next=3,regeneratorRuntime.awrap(db.warehouses.update({soluongton:t.soluongton},{where:{bookId:t.bookId}}));case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}})},upsoluongdat=function(t){var r;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("obj",t.soluongdat),r=t.soluongdat+1,e.next=4,regeneratorRuntime.awrap(db.bookcarts.update({soluongdat:r},{where:_defineProperty({},_sequelize.Op.and,[{bookId:t.bookId,userId:t.userId}])}));case 4:e.sent;case 5:case"end":return e.stop()}})},createSale=function(t){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("createo day",t),e.next=3,regeneratorRuntime.awrap(db.sales.create(t));case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}})},Upsale=function(t){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log(t),e.next=3,regeneratorRuntime.awrap(db.sales.update({namesale:t.namesale,sale:t.sale},{where:{bookId:t.bookId}}));case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}})},createGiamgia=function(t){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("create giamgia ",t),e.next=3,regeneratorRuntime.awrap(db.magiamgia.create(t));case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}})},getbookadmin=function(){var t,r,n,o,a,s,u=arguments;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return t=0<u.length&&void 0!==u[0]&&u[0],2<u.length?u[2]:void 0,n=((r=1<u.length&&void 0!==u[1]?u[1]:1)-1)*_constant.BOOK_LIMIT,console.log("offsets",n),o="__book_search_keysearch_"+t+"_page_"+r+"_offset_"+n,console.log("keycache",o),e.next=9,regeneratorRuntime.awrap(cache.get(o,!0));case 9:return a=e.sent,console.log("cacheData",a),e.next=13,regeneratorRuntime.awrap(db.loaibooks.findAndCountAll({include:{model:db.books,requied:!0},limit:_constant.BOOK_LIMIT,offset:n,order:[["id","desc"]]}));case 13:return(s=e.sent).pages=Math.ceil(s.count/_constant.BOOK_LIMIT),s.current=r,e.abrupt("return",s);case 17:case"end":return e.stop()}})},_default={createBook:createBook,getBook:getBook,getbooks:getbooks,getinfobook:getinfobook,searchbook:searchbook,createWarehouse:createWarehouse,upsoluongton:upsoluongton,upsoluongdat:upsoluongdat,createSale:createSale,createGiamgia:createGiamgia,Upsale:Upsale,getbookadmin:getbookadmin};exports.default=_default;
//# sourceMappingURL=bookServices.min.js.map
